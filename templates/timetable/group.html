<!-- templates/timetable/group.html -->
{% extends "base.html" %}

{% block content %}
    <div class="flex flex-col">
    <!-- Адаптивный заголовок -->
    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-6 gap-4">
        <!-- Заголовок -->
        <div class="text-center sm:text-left">
            <h1 class="text-2xl font-bold text-gray-900">Группа {{ group_name }}</h1>
        </div>

        <!-- Контролы (на мобильном будут внизу) -->
        <div class="flex flex-col sm:flex-row gap-4 items-center">
            <select
                class="w-full sm:w-auto form-select rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"
                onchange="changeWeek(this.value)">
                {% for week in weeks %}
                    {% if week.week_number|string == request.args.get('week', current_week|string) %}
                        <option value="{{ week.week_number }}" selected>
                            Неделя {{ week.week_number }} ({{ week.date_start }} - {{ week.date_end }})
                        </option>
                    {% else %}
                        <option value="{{ week.week_number }}">
                            Неделя {{ week.week_number }} ({{ week.date_start }} - {{ week.date_end }})
                        </option>
                    {% endif %}
                {% endfor %}
            </select>

            <a href="{{ url_for('timetable.export_excel', type='group', name=group_name, week=current_week) }}"
               class="w-full sm:w-auto px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors duration-200 flex items-center justify-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"/>
                </svg>
                Экспорт в Excel
            </a>

            {% if current_user.is_authenticated and session.get('is_admin') %}
                <button
                    onclick="toggleEditMode()"
                    id="editButton"
                    class="w-full sm:w-auto px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition-colors duration-200">
                    Редактировать
                </button>
            {% endif %}
        </div>
    </div>


        <!-- Таблица расписания -->
        <!-- Таблица расписания -->
<div class="timetable-wrapper">
    <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
            <tr>
                <th class="time-header px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Время
                </th>
                {% for day_name in day_names %}
                    <th class="header-cell day-column px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider
                             {% if loop.index == current_weekday %}bg-indigo-50{% endif %}">
                        <div>{{ day_name }}</div>
                        <div class="text-xs font-normal text-gray-400 mt-1">
                            {{ dates[loop.index0] }}
                        </div>
                    </th>
                {% endfor %}
            </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
            {% for time_idx in range(8) %}
                <tr>
                    <td class="time-column px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900
                              {% if time_idx + 1 == current_pair %}bg-yellow-50{% endif %}">
                        <div class="time-slot">
                            <span>{{ time_slots[time_idx].start }} - {{ time_slots[time_idx].end }}</span>
                            {% if time_idx + 1 == current_pair %}
                                <span class="current-badge">Текущая</span>
                            {% endif %}
                        </div>
                    </td>
                    {% for day in range(1, 7) %}
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500
                                  {% if day == current_weekday %}bg-indigo-50{% endif %}
                                  {% if time_idx + 1 == current_pair %}bg-yellow-50{% endif %}
                                  {% if day == current_weekday and time_idx + 1 == current_pair %}bg-green-50{% endif %}"
                            data-day="{{ day }}"
                            data-time="{{ time_idx + 1 }}"
                            {% if current_user.is_authenticated and session.get('is_admin') %}
                            onclick="handleCellClick(event)"
                            class="cursor-pointer hover:bg-gray-50"
                            {% endif %}
                        >
                            {% set lessons = get_lessons(timetable, day, time_idx + 1) %}
                            {% if lessons %}
                                {% for lesson in lessons %}
                                    <div class="lesson-block {% if not loop.last %}mb-2{% endif %}"
                                         data-lesson='{{ lessons|tojson|safe }}'
                                         data-subject="{{ lesson.subject }}"
                                         data-type="{{ lesson.type }}"
                                         data-subgroup="{{ lesson.subgroup }}"
                                         data-teacher="{{ lesson.teachers[0].teacher_name }}"
                                         data-auditory="{{ lesson.auditories[0].auditory_name }}">
                                        <div class="font-medium text-gray-900">{{ lesson.subject }}</div>
                                        <div class="flex items-center gap-1 text-xs">
                                            <span class="px-2 py-0.5 rounded-full
                                                {% if lesson.type == 'л.' %}bg-blue-100 text-blue-800
                                                {% elif lesson.type == 'пр.' %}bg-green-100 text-green-800
                                                {% else %}bg-purple-100 text-purple-800{% endif %}">
                                                {{ lesson.type }}
                                            </span>
                                            {% if lesson.subgroup > 0 %}
                                                <span class="px-2 py-0.5 rounded-full bg-indigo-100 text-indigo-800">
                                                    Подгруппа {{ lesson.subgroup }}
                                                </span>
                                            {% endif %}
                                        </div>
                                        <div class="text-xs text-gray-500 mt-1">
                                            {{ lesson.teachers[0].teacher_name }}
                                        </div>
                                        <div class="text-xs font-medium text-gray-700">
                                            ауд. {{ lesson.auditories[0].auditory_name }}
                                        </div>
                                    </div>
                                {% endfor %}
                            {% endif %}
                        </td>
                    {% endfor %}
                </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

        <!-- Модальное окно для редактирования -->
        <!-- Модальное окно -->
<div id="editModal" class="fixed inset-0 hidden z-50" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <!-- Затемненный фон -->
    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"></div>

    <div class="fixed inset-0 z-10 overflow-y-auto">
        <div class="flex min-h-full items-center justify-center p-4 text-center sm:items-center sm:p-0">
            <div class="relative transform overflow-hidden rounded-lg bg-white text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg">
                <!-- Заголовок -->
                <div class="bg-white px-4 pb-4 pt-5 sm:p-6 sm:pb-4">
                    <h3 class="text-lg font-semibold leading-6 text-gray-900 mb-4">
                        Редактирование занятия
                    </h3>

                    <!-- Форма -->
                    <form id="editForm" class="space-y-4">
                        <!-- Выбор типа распределения -->
                        <div class="space-y-2">
                            <label class="text-sm font-medium text-gray-700">Тип распределения</label>
                            <div class="space-y-2">
                                <label class="inline-flex items-center">
                                    <input type="radio" name="groupType" value="common" class="form-radio" checked>
                                    <span class="ml-2">Общее занятие</span>
                                </label>
                                <label class="inline-flex items-center">
                                    <input type="radio" name="groupType" value="subgroup1" class="form-radio">
                                    <span class="ml-2">Только первая подгруппа</span>
                                </label>
                                <label class="inline-flex items-center">
                                    <input type="radio" name="groupType" value="subgroup2" class="form-radio">
                                    <span class="ml-2">Только вторая подгруппа</span>
                                </label>
                                <label class="inline-flex items-center">
                                    <input type="radio" name="groupType" value="both" class="form-radio">
                                    <span class="ml-2">Разные занятия для подгрупп</span>
                                </label>
                            </div>
                        </div>

                        <!-- Общий выбор типа занятия -->
                        <div id="commonTypeSelect">
                            <label class="block text-sm font-medium text-gray-700">Тип занятия</label>
                            <select name="lessonType" id="commonLessonType"
                                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                                <option value="">Выберите тип</option>
                                {% for type in unique_values.lesson_types %}
                                    <option value="{{ type }}">
                                        {% if type == 'л.' %}Лекция
                                        {% elif type == 'пр.' %}Практика
                                        {% elif type == 'лаб.' %}Лабораторная
                                        {% endif %}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Форма для общего занятия -->
                        <div id="commonForm">
                            <div class="space-y-4">
                                <!-- Предмет -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Предмет</label>
                                    <select name="subject"
                                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                                        <option value="">Выберите предмет</option>
                                        {% for subject in unique_values.subjects %}
                                            <option value="{{ subject }}">{{ subject }}</option>
                                        {% endfor %}
                                    </select>
                                </div>

                                <!-- Преподаватель -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Преподаватель</label>
                                    <select name="teacher"
                                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                                        <option value="">Выберите преподавателя</option>
                                        {% for teacher in unique_values.teachers %}
                                            <option value="{{ teacher }}">{{ teacher }}</option>
                                        {% endfor %}
                                    </select>
                                </div>

                                <!-- Аудитория -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Аудитория</label>
                                    <select name="auditory"
                                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                                        <option value="">Выберите аудиторию</option>
                                        {% for auditory in unique_values.auditories %}
                                            <option value="{{ auditory }}">{{ auditory }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Формы для подгрупп -->
                                               <!-- Формы для подгрупп -->
                       <div id="subgroupForms" class="hidden space-y-6">
                           <!-- Первая подгруппа -->
                           <div class="border-t pt-4">
                               <h4 class="font-medium text-gray-900 mb-3">Первая подгруппа</h4>
                               <div class="space-y-4">
                                   <div>
                                       <label class="block text-sm font-medium text-gray-700">Тип занятия</label>
                                       <select name="lessonType1"
                                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                                           <option value="">Выберите тип</option>
                                           {% for type in unique_values.lesson_types %}
                                               <option value="{{ type }}">
                                                   {% if type == 'л.' %}Лекция
                                                   {% elif type == 'пр.' %}Практика
                                                   {% elif type == 'лаб.' %}Лабораторная
                                                   {% endif %}
                                               </option>
                                           {% endfor %}
                                       </select>
                                   </div>
                                   <div>
                                       <label class="block text-sm font-medium text-gray-700">Предмет</label>
                                       <select name="subject1"
                                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                                           <option value="">Выберите предмет</option>
                                           {% for subject in unique_values.subjects %}
                                               <option value="{{ subject }}">{{ subject }}</option>
                                           {% endfor %}
                                       </select>
                                   </div>
                                   <div>
                                       <label class="block text-sm font-medium text-gray-700">Преподаватель</label>
                                       <select name="teacher1"
                                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                                           <option value="">Выберите преподавателя</option>
                                           {% for teacher in unique_values.teachers %}
                                               <option value="{{ teacher }}">{{ teacher }}</option>
                                           {% endfor %}
                                       </select>
                                   </div>
                                   <div>
                                       <label class="block text-sm font-medium text-gray-700">Аудитория</label>
                                       <select name="auditory1"
                                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                                           <option value="">Выберите аудиторию</option>
                                           {% for auditory in unique_values.auditories %}
                                               <option value="{{ auditory }}">{{ auditory }}</option>
                                           {% endfor %}
                                       </select>
                                   </div>
                               </div>
                           </div>

                           <!-- Вторая подгруппа -->
                           <div class="border-t pt-4">
                               <h4 class="font-medium text-gray-900 mb-3">Вторая подгруппа</h4>
                               <div class="space-y-4">
                                   <div>
                                       <label class="block text-sm font-medium text-gray-700">Тип занятия</label>
                                       <select name="lessonType2"
                                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                                           <option value="">Выберите тип</option>
                                           {% for type in unique_values.lesson_types %}
                                               <option value="{{ type }}">
                                                   {% if type == 'л.' %}Лекция
                                                   {% elif type == 'пр.' %}Практика
                                                   {% elif type == 'лаб.' %}Лабораторная
                                                   {% endif %}
                                               </option>
                                           {% endfor %}
                                       </select>
                                   </div>
                                   <div>
                                       <label class="block text-sm font-medium text-gray-700">Предмет</label>
                                       <select name="subject2"
                                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                                           <option value="">Выберите предмет</option>
                                           {% for subject in unique_values.subjects %}
                                               <option value="{{ subject }}">{{ subject }}</option>
                                           {% endfor %}
                                       </select>
                                   </div>
                                   <div>
                                       <label class="block text-sm font-medium text-gray-700">Преподаватель</label>
                                       <select name="teacher2"
                                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                                           <option value="">Выберите преподавателя</option>
                                           {% for teacher in unique_values.teachers %}
                                               <option value="{{ teacher }}">{{ teacher }}</option>
                                           {% endfor %}
                                       </select>
                                   </div>
                                   <div>
                                       <label class="block text-sm font-medium text-gray-700">Аудитория</label>
                                       <select name="auditory2"
                                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                                           <option value="">Выберите аудиторию</option>
                                           {% for auditory in unique_values.auditories %}
                                               <option value="{{ auditory }}">{{ auditory }}</option>
                                           {% endfor %}
                                       </select>
                                   </div>
                               </div>
                           </div>
                       </div>
                   </form>
               </div>

               <!-- Кнопки -->
               <div class="bg-gray-50 px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6">
                   <button type="button" onclick="saveLesson()"
                           class="inline-flex w-full justify-center rounded-md bg-indigo-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 sm:ml-3 sm:w-auto">
                       Сохранить
                   </button>
                   <button type="button" onclick="deleteLesson()"
                           class="mt-3 inline-flex w-full justify-center rounded-md bg-red-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-red-500 sm:mt-0 sm:ml-3 sm:w-auto">
                       Удалить
                   </button>
                   <button type="button" onclick="closeModal()"
                           class="mt-3 inline-flex w-full justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 sm:mt-0 sm:w-auto">
                       Отмена
                   </button>
               </div>
           </div>
       </div>
   </div>
</div>
    </div>

    <!-- Уведомления -->
    <div id="notification"
         class="fixed top-4 right-4 z-50 max-w-sm hidden transform transition-transform duration-300 ease-in-out">
        <div class="rounded-lg p-4 flex items-center space-x-3">
            <!-- Содержимое уведомления будет добавляться динамически -->
        </div>
    </div>

    <script>

        let editMode = false;
        let currentCell = null;
        let currentDay = null;
        let currentTimeSlot = null;

        function toggleEditMode() {
            editMode = !editMode;
            const button = document.getElementById('editButton');
            const cells = document.querySelectorAll('td:not(:first-child)');

            if (editMode) {
                button.textContent = 'Завершить редактирование';
                button.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
                button.classList.add('bg-green-600', 'hover:bg-green-700');

                cells.forEach(cell => {
                    cell.classList.add('cursor-pointer', 'hover:bg-gray-50');
                    cell.addEventListener('click', handleCellClick);
                });
            } else {
                button.textContent = 'Редактировать';
                button.classList.remove('bg-green-600', 'hover:bg-green-700');
                button.classList.add('bg-indigo-600', 'hover:bg-indigo-700');

                cells.forEach(cell => {
                    cell.classList.remove('cursor-pointer', 'hover:bg-gray-50');
                    cell.removeEventListener('click', handleCellClick);
                });
            }

        }

        function handleCellClick(event) {
            if (!editMode) return;

            // Находим родительскую ячейку
            let targetElement = event.target;
            while (targetElement && targetElement.tagName !== 'TD') {
                targetElement = targetElement.parentElement;
            }

            if (!targetElement) return;

            currentCell = targetElement;
            currentDay = parseInt(targetElement.dataset.day);
            currentTime = parseInt(targetElement.dataset.time);

            console.log('Clicked cell:', {
                day: currentDay,
                time: currentTime
            });

            // Очищаем форму
            document.getElementById('editForm').reset();

            // Получаем все div с занятиями в ячейке
            const lessonDivs = targetElement.querySelectorAll('div[data-lesson]');

            if (lessonDivs.length > 0) {
                console.log('Найдено занятий:', lessonDivs.length);

                let lessons = [];
                lessonDivs.forEach(div => {
                    try {
                        const lessonData = JSON.parse(div.dataset.lesson);
                        if (Array.isArray(lessonData)) {
                            lessons = lessons.concat(lessonData);
                        } else {
                            lessons.push(lessonData);
                        }
                    } catch (e) {
                        console.error('Ошибка при разборе данных занятия:', e);
                        try {
                            // Пробуем собрать данные из отдельных атрибутов
                            lessons.push({
                                subject: div.dataset.subject,
                                type: div.dataset.type,
                                subgroup: parseInt(div.dataset.subgroup || '0'),
                                teachers: [{teacher_name: div.dataset.teacher}],
                                auditories: [{auditory_name: div.dataset.auditory}]
                            });
                        } catch (e2) {
                            console.error('Ошибка при сборе данных из атрибутов:', e2);
                        }
                    }
                });

                // Сортируем занятия по номеру подгруппы
                lessons.sort((a, b) => a.subgroup - b.subgroup);

                if (lessons.length === 1) {
                    // Одно занятие
                    const lesson = lessons[0];
                    if (lesson.subgroup === 0) {
                        setGroupType('common');
                        fillCommonForm(lesson);
                    } else {
                        setGroupType(`subgroup${lesson.subgroup}`);
                        fillCommonForm(lesson);
                    }
                } else if (lessons.length >= 2) {
                    // Два занятия - разные подгруппы
                    setGroupType('both');
                    fillSubgroupForms(lessons);
                }
            } else {
                // Новое занятие
                setGroupType('common');
            }

            const modal = document.getElementById('editModal');
            modal.classList.remove('hidden');
        }

        function setGroupType(type) {
            const radio = document.querySelector(`input[name="groupType"][value="${type}"]`);
            if (radio) {
                radio.checked = true;
                toggleForms(type);
            }
        }

        function toggleForms(type) {
            console.log('Переключение формы на тип:', type);

            const commonForm = document.getElementById('commonForm');
            const subgroupForms = document.getElementById('subgroupForms');
            const commonTypeSelect = document.getElementById('commonTypeSelect');

            if (type === 'both') {
                // Для двух подгрупп
                commonForm.classList.add('hidden');
                subgroupForms.classList.remove('hidden');
                commonTypeSelect.classList.add('hidden');

                // Сбрасываем значения общей формы
                const commonSelects = commonForm.querySelectorAll('select');
                commonSelects.forEach(select => select.value = '');

                // Убираем подсветку ошибок, если они были
                const allSelects = document.querySelectorAll('select');
                allSelects.forEach(select => {
                    select.classList.remove('border-red-500', 'ring-red-500');
                });
            } else {
                // Для общего занятия или одной подгруппы
                commonForm.classList.remove('hidden');
                subgroupForms.classList.add('hidden');
                commonTypeSelect.classList.remove('hidden');

                // Сбрасываем значения форм подгрупп
                const subgroupSelects = subgroupForms.querySelectorAll('select');
                subgroupSelects.forEach(select => select.value = '');

                // Убираем подсветку ошибок, если они были
                const allSelects = document.querySelectorAll('select');
                allSelects.forEach(select => {
                    select.classList.remove('border-red-500', 'ring-red-500');
                });
            }
        }

        function fillCommonForm(lesson) {
            if (lesson) {
                // Заполняем тип занятия
                const typeSelect = document.querySelector('#commonLessonType');
                if (typeSelect) {
                    typeSelect.value = lesson.type || '';
                    console.log('Заполнен тип занятия:', lesson.type);
                }

                // Заполняем предмет
                const subjectSelect = document.querySelector('select[name="subject"]');
                if (subjectSelect) {
                    subjectSelect.value = lesson.subject || '';
                    console.log('Заполнен предмет:', lesson.subject);
                }

                // Заполняем преподавателя
                const teacherSelect = document.querySelector('select[name="teacher"]');
                if (teacherSelect && lesson.teachers && lesson.teachers.length > 0) {
                    teacherSelect.value = lesson.teachers[0].teacher_name || '';
                    console.log('Заполнен преподаватель:', lesson.teachers[0].teacher_name);
                }

                // Заполняем аудиторию
                const auditorySelect = document.querySelector('select[name="auditory"]');
                if (auditorySelect && lesson.auditories && lesson.auditories.length > 0) {
                    auditorySelect.value = lesson.auditories[0].auditory_name || '';
                    console.log('Заполнена аудитория:', lesson.auditories[0].auditory_name);
                }

                console.log('Заполнены данные для формы:', {
                    subject: lesson.subject,
                    type: lesson.type,
                    teacher: lesson.teachers?.[0]?.teacher_name,
                    auditory: lesson.auditories?.[0]?.auditory_name
                });
            }
        }

        function fillSubgroupForms(lessons) {
            console.log('Заполнение форм для подгрупп:', lessons);

            lessons.forEach(lesson => {
                if (!lesson) return;

                const index = lesson.subgroup;
                console.log(`Заполнение данных для подгруппы ${index}:`, lesson);

                // Заполняем тип занятия для конкретной подгруппы
                const typeSelect = document.querySelector(`select[name="lessonType${index}"]`);
                if (typeSelect) {
                    typeSelect.value = lesson.type || '';
                    console.log(`Заполнен тип занятия для подгруппы ${index}:`, lesson.type);
                }

                // Заполняем предмет
                const subjectSelect = document.querySelector(`select[name="subject${index}"]`);
                if (subjectSelect) {
                    subjectSelect.value = lesson.subject || '';
                    console.log(`Заполнен предмет для подгруппы ${index}:`, lesson.subject);
                }

                // Заполняем преподавателя
                const teacherSelect = document.querySelector(`select[name="teacher${index}"]`);
                if (teacherSelect && lesson.teachers && lesson.teachers.length > 0) {
                    teacherSelect.value = lesson.teachers[0].teacher_name || '';
                    console.log(`Заполнен преподаватель для подгруппы ${index}:`, lesson.teachers[0].teacher_name);
                }

                // Заполняем аудиторию
                const auditorySelect = document.querySelector(`select[name="auditory${index}"]`);
                if (auditorySelect && lesson.auditories && lesson.auditories.length > 0) {
                    auditorySelect.value = lesson.auditories[0].auditory_name || '';
                    console.log(`Заполнена аудитория для подгруппы ${index}:`, lesson.auditories[0].auditory_name);
                }
            });
        }

        function deleteLesson() {
            console.log('Удаление пары...', {
                currentDay,
                currentTime,
                currentCell: currentCell ? currentCell.dataset : 'нет ячейки'
            });

            if (!currentDay || !currentTime) {
                showNotification('Не удалось определить день или время пары', 'ERROR');
                return;
            }


            // Запрашиваем подтверждение
            if (!confirm('Вы уверены, что хотите удалить эту пару?')) {
                return;
            }

            const requestData = {
                group_name: '{{ group_name }}',
                day: currentDay,
                time: currentTime,
                lessons: [] // Пустой массив для удаления
            };

            console.log('Отправляемые данные для удаления:', requestData);

            fetch('/timetable/api/update', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestData)
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Ответ сервера:', data);
                    if (data.status === 'success') {
                        closeModal();
                        window.location.reload();
                    } else {
                        console.error('Ошибка удаления:', data.error);
                        alert('Ошибка удаления пары: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Ошибка запроса:', error);
                    alert('Ошибка удаления пары: ' + error);
                });
        }

function saveLesson() {
    console.log('Сохранение...', {
        currentDay,
        currentTime,
        currentCell: currentCell ? currentCell.dataset : 'нет ячейки'
    });

    if (!currentDay || !currentTime) {
        showNotification('Ошибка: не удалось определить день или время пары', 'ERROR');
        return;
    }

    // Получаем текущую неделю из URL
    const urlParams = new URLSearchParams(window.location.search);
    const currentWeek = urlParams.get('week');

    if (!currentWeek) {
        showNotification('Ошибка: не удалось определить текущую неделю', 'ERROR');
        return;
    }

    // Получаем текущие данные занятия
    const currentLessons = [];
    const lessonDivs = currentCell.querySelectorAll('div[data-lesson]');
    lessonDivs.forEach(div => {
        try {
            const lessonData = JSON.parse(div.dataset.lesson);
            if (Array.isArray(lessonData)) {
                currentLessons.push(...lessonData);
            } else {
                currentLessons.push(lessonData);
            }
        } catch (e) {
            console.error('Ошибка при разборе текущих данных:', e);
        }
    });

    // Получаем тип распределения
    const groupType = document.querySelector('input[name="groupType"]:checked').value;
    let newLessonData;

    try {
        if (groupType === 'common') {
            // Общее занятие
            const subject = document.querySelector('select[name="subject"]').value;
            const type = document.querySelector('#commonLessonType').value;
            const teacher = document.querySelector('select[name="teacher"]').value;
            const auditory = document.querySelector('select[name="auditory"]').value;

            if (!subject || !type || !teacher || !auditory) {
                showNotification('Пожалуйста, заполните все поля', 'WARNING');
                highlightEmptyFields(['subject', 'lessonType', 'teacher', 'auditory']);
                return;
            }

            newLessonData = [{
                subject: subject,
                type: type,
                subgroup: 0,
                time: currentTime,
                teachers: [{teacher_name: teacher, teacher_id: "1", teacher_post: ""}],
                auditories: [{auditory_name: auditory}],
                Lesson_ID_Num: `${currentDay}_${currentTime}_0`,
                week: parseInt(currentWeek)
            }];
        } else if (groupType === 'subgroup1' || groupType === 'subgroup2') {
            // Занятие для одной подгруппы
            const subgroup = groupType === 'subgroup1' ? 1 : 2;
            const subject = document.querySelector('select[name="subject"]').value;
            const type = document.querySelector('#commonLessonType').value;
            const teacher = document.querySelector('select[name="teacher"]').value;
            const auditory = document.querySelector('select[name="auditory"]').value;

            if (!subject || !type || !teacher || !auditory) {
                showNotification('Пожалуйста, заполните все поля', 'WARNING');
                highlightEmptyFields(['subject', 'lessonType', 'teacher', 'auditory']);
                return;
            }

            newLessonData = [{
                subject: subject,
                type: type,
                subgroup: subgroup,
                time: currentTime,
                teachers: [{teacher_name: teacher, teacher_id: "1", teacher_post: ""}],
                auditories: [{auditory_name: auditory}],
                Lesson_ID_Num: `${currentDay}_${currentTime}_${subgroup}`,
                week: parseInt(currentWeek)
            }];
        } else if (groupType === 'both') {
            // Занятия для обеих подгрупп
            const subject1 = document.querySelector('select[name="subject1"]').value;
            const subject2 = document.querySelector('select[name="subject2"]').value;
            const type1 = document.querySelector('select[name="lessonType1"]').value;
            const type2 = document.querySelector('select[name="lessonType2"]').value;
            const teacher1 = document.querySelector('select[name="teacher1"]').value;
            const teacher2 = document.querySelector('select[name="teacher2"]').value;
            const auditory1 = document.querySelector('select[name="auditory1"]').value;
            const auditory2 = document.querySelector('select[name="auditory2"]').value;

            if (!subject1 || !type1 || !teacher1 || !auditory1) {
                showNotification('Пожалуйста, заполните все поля для первой подгруппы', 'WARNING');
                highlightEmptyFields(['subject1', 'lessonType1', 'teacher1', 'auditory1']);
                return;
            }

            if (!subject2 || !type2 || !teacher2 || !auditory2) {
                showNotification('Пожалуйста, заполните все поля для второй подгруппы', 'WARNING');
                highlightEmptyFields(['subject2', 'lessonType2', 'teacher2', 'auditory2']);
                return;
            }

            newLessonData = [
                {
                    subject: subject1,
                    type: type1,
                    subgroup: 1,
                    time: currentTime,
                    teachers: [{teacher_name: teacher1, teacher_id: "1", teacher_post: ""}],
                    auditories: [{auditory_name: auditory1}],
                    Lesson_ID_Num: `${currentDay}_${currentTime}_1`,
                    week: parseInt(currentWeek)
                },
                {
                    subject: subject2,
                    type: type2,
                    subgroup: 2,
                    time: currentTime,
                    teachers: [{teacher_name: teacher2, teacher_id: "2", teacher_post: ""}],
                    auditories: [{auditory_name: auditory2}],
                    Lesson_ID_Num: `${currentDay}_${currentTime}_2`,
                    week: parseInt(currentWeek)
                }
            ];
        }

        // Логируем изменения
        console.log('Текущее состояние:', currentLessons);
        console.log('Новое состояние:', newLessonData);

        // Показываем информацию об изменениях
        let changes = '';

        if (currentLessons.length === 0 && newLessonData.length > 0) {
            changes = 'Добавление новой пары:';
            newLessonData.forEach(lesson => {
                changes += `\n- ${lesson.subject} (${lesson.type})`;
                if (lesson.subgroup) changes += ` [Подгруппа ${lesson.subgroup}]`;
                changes += `\n  Преподаватель: ${lesson.teachers[0].teacher_name}`;
                changes += `\n  Аудитория: ${lesson.auditories[0].auditory_name}`;
            });
        } else if (currentLessons.length > 0 && newLessonData.length === 0) {
            changes = 'Удаление пары:';
            currentLessons.forEach(lesson => {
                changes += `\n- ${lesson.subject} (${lesson.type})`;
                if (lesson.subgroup) changes += ` [Подгруппа ${lesson.subgroup}]`;
            });
        } else {
            changes = 'Изменение пары:';
            newLessonData.forEach((newLesson, index) => {
                const oldLesson = currentLessons[index];
                if (oldLesson) {
                    changes += `\n\nПодгруппа ${newLesson.subgroup || 'общая'}:`;
                    if (oldLesson.subject !== newLesson.subject) {
                        changes += `\n- Предмет: ${oldLesson.subject} → ${newLesson.subject}`;
                    }
                    if (oldLesson.type !== newLesson.type) {
                        changes += `\n- Тип: ${oldLesson.type} → ${newLesson.type}`;
                    }
                    if (oldLesson.teachers[0]?.teacher_name !== newLesson.teachers[0]?.teacher_name) {
                        changes += `\n- Преподаватель: ${oldLesson.teachers[0]?.teacher_name} → ${newLesson.teachers[0]?.teacher_name}`;
                    }
                    if (oldLesson.auditories[0]?.auditory_name !== newLesson.auditories[0]?.auditory_name) {
                        changes += `\n- Аудитория: ${oldLesson.auditories[0]?.auditory_name} → ${newLesson.auditories[0]?.auditory_name}`;
                    }
                } else {
                    changes += `\n\nДобавлена подгруппа ${newLesson.subgroup}:`;
                    changes += `\n- Предмет: ${newLesson.subject}`;
                    changes += `\n- Тип: ${newLesson.type}`;
                    changes += `\n- Преподаватель: ${newLesson.teachers[0]?.teacher_name}`;
                    changes += `\n- Аудитория: ${newLesson.auditories[0]?.auditory_name}`;
                }
            });
        }

        console.log('Изменения:', changes);
        showNotification(changes, 'INFO', 8000); // Увеличиваем время показа до 8 секунд

        const requestData = {
            group_name: '{{ group_name }}',
            day: currentDay,
            time: currentTime,
            lessons: newLessonData
        };

        console.log('Отправляемые данные:', requestData);

        fetch(`/timetable/api/update?week=${currentWeek}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestData)
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Ответ сервера:', data);
            if (data.status === 'success') {
                showNotification('Изменения сохранены успешно', 'SUCCESS');
                closeModal();
                // Перезагружаем страницу с сохранением текущей недели
                window.location.href = `?week=${currentWeek}`;
            } else {
                throw new Error(data.error || 'Ошибка сохранения');
            }
        })
        .catch(error => {
            console.error('Ошибка запроса:', error);
            showNotification('Ошибка сохранения изменений: ' + error.message, 'ERROR');
        });

    } catch (error) {
        console.error('Ошибка при формировании данных:', error);
        showNotification('Ошибка при формировании данных: ' + error.message, 'ERROR');
    }
}

// Вспомогательная функция для подсветки пустых полей
function highlightEmptyFields(fieldNames) {
    fieldNames.forEach(name => {
        const field = document.querySelector(`select[name="${name}"]`);
        if (field && !field.value) {
            field.classList.add('border-red-500', 'ring-red-500');
            // Убираем подсветку через 3 секунды
            setTimeout(() => {
                field.classList.remove('border-red-500', 'ring-red-500');
            }, 3000);
        }
    });
}

        function closeModal() {
            const modal = document.getElementById('editModal');
            modal.classList.add('hidden');
            currentCell = null;
            currentDay = null;
            currentTime = null;
        }

        // Инициализация обработчиков
        document.querySelectorAll('input[name="groupType"]').forEach(radio => {
            radio.addEventListener('change', function () {
                toggleForms(this.value);
            });
        });

        function changeWeek(weekNumber) {
        updateExportLink(weekNumber);
        const currentUrl = new URL(window.location.href);
        currentUrl.searchParams.set('week', weekNumber);
        window.location.href = currentUrl.toString();
    }



        // Добавляем обработчики для предметов, которые могут влиять на выбор преподавателей
        document.querySelectorAll('select[name^="subject"]').forEach(select => {
            select.addEventListener('change', function () {
                // Получаем индекс подгруппы из имени селекта (если есть)
                const subgroupIndex = this.name.replace('subject', '');
                const teacherSelect = document.querySelector(`select[name="teacher${subgroupIndex}"]`);
                if (teacherSelect) {
                    // Здесь можно добавить логику фильтрации преподавателей по предмету
                    console.log(`Изменен предмет для подгруппы ${subgroupIndex}: ${this.value}`);
                }
            });
        });

        // Добавляем обработчики для типа занятия, которые могут влиять на выбор аудиторий
        document.querySelector('#commonLessonType').addEventListener('change', function () {
            const type = this.value;
            console.log(`Изменен тип занятия: ${type}`);
            // Здесь можно добавить логику фильтрации аудиторий по типу занятия
        });

        document.addEventListener('click', function (event) {
            const modal = document.getElementById('editModal');
            const modalContent = modal.querySelector('.relative');

            if (event.target === modal) {
                closeModal();
            }
        });

        // Функция для проверки конфликтов
        function checkConflicts(data) {
            // Здесь можно добавить проверку конфликтов:
            // - Преподаватель в это время не занят
            // - Аудитория свободна
            // - Нет пересечений с другими парами
            return true; // Пока всегда возвращаем true
        }

        // Функция для отображения ошибок
        function showError(message) {
            console.error(message);
            alert(message);
        }

        // Функция для отображения успеха
        function showSuccess(message) {
            console.log(message);
            // Здесь можно добавить красивое уведомление об успехе
        }

        // Функция для проверки обязательных полей
        function validateRequiredFields(fields) {
            for (let field of fields) {
                if (!field.value) {
                    field.classList.add('border-red-500');
                    return false;
                } else {
                    field.classList.remove('border-red-500');
                }
            }
            return true;
        }

        // Инициализация всех обработчиков при загрузке страницы
        document.addEventListener('DOMContentLoaded', function () {

            setSelectedWeek();
            // Инициализация радио-кнопок
            document.querySelectorAll('input[name="groupType"]').forEach(radio => {
                radio.addEventListener('change', function () {
                    toggleForms(this.value);
                });
            });

            // Инициализация селектов
            document.querySelectorAll('select').forEach(select => {
                select.addEventListener('change', function () {
                    this.classList.remove('border-red-500');
                });
            });

            // Установка начального состояния форм
            const initialGroupType = document.querySelector('input[name="groupType"]:checked').value;
            toggleForms(initialGroupType);
        });

        // Вспомогательные функции для работы с данными
        function formatDate(date) {
            return date.toLocaleDateString('ru-RU');
        }

        function formatTime(time) {
            return time.substring(0, 5);
        }

        function updateExportLink(weekNumber) {
        const exportLink = document.querySelector('a[href*="/export/"]');
        if (exportLink) {
            const currentHref = new URL(exportLink.href);
            currentHref.searchParams.set('week', weekNumber);
            exportLink.href = currentHref.toString();
        }
    }

        function generateLessonId(day, time, subgroup) {
            return `${day}_${time}_${subgroup}_${Date.now()}`;
        }

        const NOTIFICATION_TYPES = {
    SUCCESS: {
        bgColor: 'bg-green-500',
        icon: `<svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
        </svg>`
    },
    ERROR: {
        bgColor: 'bg-red-500',
        icon: `<svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>`
    },
    WARNING: {
        bgColor: 'bg-yellow-500',
        icon: `<svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
        </svg>`
    },
    INFO: {
        bgColor: 'bg-blue-500',
        icon: `<svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>`
    }
};

        function showNotification(message, type = 'ERROR', duration = 3000) {
            const notification = document.getElementById('notification');
            const {bgColor, icon} = NOTIFICATION_TYPES[type];

            // Создаем содержимое уведомления
            notification.querySelector('div').className = `rounded-lg p-4 shadow-lg ${bgColor} text-white flex items-center space-x-3`;
            notification.querySelector('div').innerHTML = `
        <div class="flex-shrink-0">
            ${icon}
        </div>
        <div class="flex-1">
            ${message}
        </div>
    `;

            // Показываем уведомление
            notification.classList.remove('hidden');
            notification.classList.add('animate-fade-in');

            // Скрываем через заданное время
            setTimeout(() => {
                notification.classList.add('animate-fade-out');
                setTimeout(() => {
                    notification.classList.add('hidden');
                    notification.classList.remove('animate-fade-in', 'animate-fade-out');
                }, 300);
            }, duration);
        }

        function getUrlParameter(name) {
    const searchParams = new URLSearchParams(window.location.search);
    return searchParams.get(name);
}

        function setSelectedWeek() {
    const weekSelect = document.querySelector('select[onchange="changeWeek(this.value)"]');
    if (!weekSelect) return;

    const urlWeek = getUrlParameter('week');
    if (urlWeek) {
        weekSelect.value = urlWeek;
    }
}






    </script>
{% endblock %}